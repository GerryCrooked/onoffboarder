<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>On-/Offboarding</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/themes/default/style.min.css" rel="stylesheet">
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="p-4">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">On-/Offboarding</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">Formular</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin">Admin</a>
                </li>
                <li>
                    <a class="nav-link" href="/archived">Archiv</a>
                </li>
            </ul>
            <ul class="navbar-nav">
                {% if session.user %}
                <li class="nav-item">
                    <a class="nav-link" href="#">üë§ {{ session.user }}</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout">Logout</a>
                </li>
                {% else %}
                <li class="nav-item">
                    <a class="nav-link" href="/login">Login</a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

    <div class="container">
        <h1>On-/Offboarding Formular</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category or 'info' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}


        <form method="POST" id="onoffboarding-form"> <div class="mb-3">
                <label for="process_type" class="form-label">Prozess</label>
                <select id="process_type" name="process_type" class="form-select">
                    <option value="onboarding">Onboarding</option>
                    <option value="offboarding">Offboarding</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="lastname" class="form-label">Nachname</label>
                <input type="text" id="lastname" name="lastname" class="form-control" value="{{ form_data.lastname if form_data else '' }}" required>
            </div>
            <div class="mb-3">
                <label for="firstname" class="form-label">Vorname</label>
                <input type="text" id="firstname" name="firstname" class="form-control" value="{{ form_data.firstname if form_data else '' }}" required>
            </div>
             <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="startdate" class="form-label">Startdatum (Onboarding)</label>
                    <input type="date" id="startdate" name="startdate" class="form-control" value="{{ form_data.startdate if form_data else today }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="enddate" class="form-label">Austrittsdatum (Offboarding)</label>
                    <input type="date" id="enddate" name="enddate" class="form-control" value="{{ form_data.enddate if form_data else '' }}">
                </div>
            </div>


            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="needs_windows_user" name="needs_windows_user" value="true" onchange="toggleWindowsUserFields()" {{ 'checked' if form_data and form_data.needs_windows_user == 'true' else '' }}>
                <label class="form-check-label" for="needs_windows_user">Windows Benutzerkonto ben√∂tigt</label>
            </div>

            <div id="windows_user_fields" class="{{ 'hidden' if not form_data or form_data.needs_windows_user != 'true' else '' }}">
                 <hr>
                 <h5>Angaben f√ºr Windows Benutzerkonto</h5>
                <div class="mb-3">
                    <label class="form-label">Abteilung (aus OU w√§hlen)</label>
                    <input type="text" id="department" name="department" class="form-control" value="{{ form_data.department if form_data else '' }}" readonly required>
                    <input type="hidden" id="department_dn" name="department_dn" value="{{ form_data.department_dn if form_data else '' }}">
                    <div id="ou-tree" class="border p-2 mt-2" style="max-height: 300px; overflow-y: scroll;">
                        <p>Lade Abteilungsstruktur...</p>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="referenceuser" class="form-label">Referenzbenutzer (optional)</label>
                    <select id="referenceuser" name="referenceuser" class="form-select">
                        <option value="">Bitte Abteilung w√§hlen</option>
                        </select>
                </div>

                <div class="mb-3">
                    <label for="supervisor" class="form-label">Vorgesetzter</label>
                    <select id="supervisor" name="supervisor" class="form-select" required>
                         <option value="">Bitte Abteilung w√§hlen oder warten</option>
                         </select>
                </div>
                 <hr>
            </div>

            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="needs_hardware" name="needs_hardware" value="true" onchange="toggleHardwareFields()" {{ 'checked' if form_data and form_data.needs_hardware == 'true' else '' }}>
                <label class="form-check-label" for="needs_hardware">Hardware wird ben√∂tigt</label>
            </div>

            <div id="hardware_fields" class="{{ 'hidden' if not form_data or form_data.needs_hardware != 'true' else '' }}">
                 <hr>
                 <h5>Hardware</h5>
                 <div class="mb-3">
                     <label>Computer:</label><br>
                     <div class="form-check">
                         <input class="form-check-input" type="radio" name="hardware_computer" value="Computer bereits vorhanden" id="hwComputer0">
                         <label class="form-check-label" for="hwComputer0">Ger√§t bereits vorhanden</label>
                     </div>
                     <div class="form-check">
                         <input class="form-check-input" type="radio" name="hardware_computer" value="Computer" id="hwComputer1">
                         <label class="form-check-label" for="hwComputer1">Computer (Festarbeitsplatz Rechner)</label>
                     </div>
                     <div class="form-check">
                         <input class="form-check-input" type="radio" name="hardware_computer" value="Laptop" id="hwComputer2">
                         <label class="form-check-label" for="hwComputer2">Laptop</label>
                     </div>

                     <div class="form-check mt-2" id="dockingstationDiv" style="display: none;">
                         <input class="form-check-input" type="checkbox" name="hardware_accessories[]" value="Dockingstation" id="Dockingstation">
                         <label class="form-check-label" for="Dockingstation">Dockingstation ben√∂tigt</label>
                     </div>
                 </div>

                 <div class="mb-3">
                     <label>Monitor:</label><br>
                     <div class="form-check">
                         <input class="form-check-input" type="radio" name="hardware_monitor" value="Monitor(e) bereits vorhanden" id="monitor0">
                         <label class="form-check-label" for="monitor0">Monitor(e) bereits vorhanden</label>
                     </div>
                     <div class="form-check">
                         <input class="form-check-input" type="radio" name="hardware_monitor" value="1 Monitor" id="monitor1">
                         <label class="form-check-label" for="monitor1">1 Monitor</label>
                     </div>
                     <div class="form-check">
                         <input class="form-check-input" type="radio" name="hardware_monitor" value="2 Monitore" id="monitor2">
                         <label class="form-check-label" for="monitor2">2 Monitore</label>
                     </div>
                 </div>

                 <div class="mb-3">
                     <label>Zubeh√∂r:</label><br>
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" name="hardware_accessories[]" value="Maus und Tastatur" id="accessories0">
                         <label class="form-check-label" for="accessories0">Maus und Tastatur</label>
                     </div>
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" name="hardware_accessories[]" value="Headset" id="accessories1">
                         <label class="form-check-label" for="accessories1">Headset</label>
                     </div>
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" name="hardware_accessories[]" value="Webcam" id="accessories2">
                         <label class="form-check-label" for="accessories2">Webcam</label>
                     </div>
                 </div>
                 <hr>
            </div>

            <div class="mb-3">
                 <label>Mobiles Datenendger√§t:</label><br>
                 <div class="form-check">
                     <input class="form-check-input" type="checkbox" name="hardware_mobile[]" value="Tablet" id="mobileTablet">
                     <label class="form-check-label" for="mobileTablet">Tablet</label>
                 </div>
                 <div class="form-check">
                     <input class="form-check-input" type="checkbox" name="hardware_mobile[]" value="Handy" id="mobileHandy">
                     <label class="form-check-label" for="mobileHandy">Handy</label>
                 </div>
             </div>

            <div class="mb-3">
                <label>Zutrittsverwaltung:</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="key_required" id="key_required" value="true" {{ 'checked' if form_data and form_data.key_required == 'true' else '' }}>
                    <label class="form-check-label" for="key_required">Schl√ºssel ben√∂tigt</label>
                </div>
            </div>

            <div class="mb-3">
                <label for="comments" class="form-label">Kommentare</label>
                <textarea id="comments" name="comments" class="form-control">{{ form_data.comments if form_data else '' }}</textarea>
            </div>

            <button type="submit" class="btn btn-primary">Absenden</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/jstree.min.js"></script>
    <script>

        // Funktion zum Umschalten der Sichtbarkeit der Windows-Benutzer-Felder
        function toggleWindowsUserFields() {
            console.log("toggleWindowsUserFields aufgerufen");
            const windowsUserFields = $('#windows_user_fields');
            const needsWindowsUserCheckbox = $('#needs_windows_user');
            const departmentInput = $('#department');
            const supervisorSelect = $('#supervisor');
            const ouTreeDiv = $('#ou-tree');
            const isChecked = needsWindowsUserCheckbox.prop('checked');
            console.log("needsWindowsUserCheckbox checked:", isChecked);

            windowsUserFields.toggleClass('hidden', !isChecked);
            console.log("windowsUserFields visibility:", windowsUserFields.is(':visible'));

            // Setze 'required' f√ºr Felder, die nur bei Bedarf ausgef√ºllt werden m√ºssen
            departmentInput.prop('required', isChecked);
            supervisorSelect.prop('required', isChecked);

            if (isChecked && !ouTreeDiv.data('jstree')) {
                 // Initialisiere jstree nur, wenn es ben√∂tigt wird und noch nicht existiert
                 console.log("Initialisiere jsTree");
                 ouTreeDiv.jstree({
                    'core': {
                        'data': {
                            'url': '/ou_tree', // Holt die Baumdaten vom Backend
                            'dataType': 'json',
                             'error': function(jqXHR, textStatus, errorThrown) {
                                console.error("Fehler beim Laden des OU-Baums:", textStatus, errorThrown);
                                ouTreeDiv.html('<p class="text-danger">Fehler beim Laden der Abteilungsstruktur.</p>');
                            }
                        }
                    }
                 }).on('loaded.jstree', function() {
                      console.log("jsTree geladen.");
                      ouTreeDiv.find('p').remove(); // Entferne "Lade..." Nachricht
                 });
            } else if (!isChecked && ouTreeDiv.data('jstree')) {
                 // Optional: Zerst√∂re Baum, wenn Checkbox deaktiviert wird
                 // console.log("Zerst√∂re jsTree");
                 // ouTreeDiv.jstree("destroy").empty();
                 // ouTreeDiv.html('<p>Abteilungsstruktur wird geladen, wenn ben√∂tigt.</p>'); // Platzhalter
                 // Leere auch abh√§ngige Felder
                 departmentInput.val('');
                 $('#department_dn').val('');
                 $('#referenceuser').empty().append(new Option("Bitte w√§hlen", ""));
                 // Lade die globale Supervisor-Liste neu oder setze zur√ºck
                 loadInitialSupervisors(); // L√§dt alle Vorgesetzten neu
            }
        };

        // Funktion zum Umschalten der Sichtbarkeit der Hardware-Felder
        function toggleHardwareFields() {
            console.log("toggleHardwareFields aufgerufen");
            const hardwareFieldsDiv = $('#hardware_fields');
            const needsHardwareCheckbox = $('#needs_hardware');
            const isChecked = needsHardwareCheckbox.prop('checked');
            console.log("needsHardwareCheckbox checked:", isChecked);

            hardwareFieldsDiv.toggleClass('hidden', !isChecked);
            console.log("hardwareFieldsDiv visibility:", hardwareFieldsDiv.is(':visible'));

             // Setze required f√ºr Radio-Buttons (nur einer pro Gruppe)
             $('input[name="hardware_computer"]').prop('required', isChecked);
             $('input[name="hardware_monitor"]').prop('required', isChecked);

             if (!isChecked) {
                  // Optional: Setze Hardware-Felder zur√ºck, wenn Checkbox deaktiviert wird
                   $('input[name="hardware_computer"]').prop('checked', false);
                   $('input[name="hardware_monitor"]').prop('checked', false);
                   $('input[name="hardware_accessories[]"]').prop('checked', false);
                   $('#dockingstationDiv').hide(); // Dockingstation auch ausblenden
             }
        };

        // --- NEUE HILFSFUNKTION zum Bef√ºllen der Vorgesetzten-Liste ---
        function populateSupervisorDropdown(supervisors) {
            const supervisorSelect = $('#supervisor');
            supervisorSelect.empty().append('<option value="">--- Bitte w√§hlen ---</option>'); // Standardoption leeren/hinzuf√ºgen

            if (supervisors && supervisors.length > 0) {
                 console.log(`F√ºlle Vorgesetzten-Dropdown mit ${supervisors.length} Eintr√§gen.`);
                 supervisors.forEach(supervisor => {
                    // Verwende E-Mail als Wert, wenn vorhanden, sonst DN, sonst Name
                    let supervisorValue = supervisor.mail ? supervisor.mail : (supervisor.dn ? supervisor.dn : supervisor.name);
                    let supervisorText = supervisor.name + (supervisor.mail ? ` (${supervisor.mail})` : ''); // Name (E-Mail)
                    supervisorSelect.append($('<option>', {
                        value: supervisorValue,
                        text: supervisorText
                    }));
                 });
            } else {
                 console.log("Keine Vorgesetzten zum Bef√ºllen des Dropdowns gefunden.");
                 supervisorSelect.append('<option value="" disabled>Keine Vorgesetzten gefunden</option>'); // Hinweis
            }
        }

        // Funktion zum Laden der Referenzbenutzer f√ºr eine OU
        function fetchUsersForReference(ouDn) {
             const referenceUserSelect = $('#referenceuser');
             referenceUserSelect.empty().append(new Option("Lade Benutzer...", "")); // Ladeanzeige

             // URL f√ºr die Benutzer in der OU
             const url = `/ou_users?dn=${encodeURIComponent(ouDn)}`;
             console.log("Lade Referenzbenutzer von:", url);

             fetch(url)
                .then(response => {
                     if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                     return response.json();
                 })
                 .then(users => {
                     console.log(`Empfangene Referenzbenutzer (${users.length}):`, users);
                     referenceUserSelect.empty().append(new Option("--- Bitte w√§hlen ---", "")); // Zur√ºcksetzen
                     if (users && users.length > 0) {
                        users.forEach(user => {
                            // Verwende sAMAccountName als Wert
                            let userValue = user.sAMAccountName ? user.sAMAccountName : user.name;
                            let userText = user.name + (user.sAMAccountName ? ` (${user.sAMAccountName})` : '');
                            referenceUserSelect.append(new Option(userText, userValue));
                        });
                     } else {
                          referenceUserSelect.append('<option value="" disabled>Keine Benutzer in OU</option>');
                     }
                 })
                 .catch(error => {
                     console.error("Fehler beim Laden der Referenzbenutzer:", error);
                     referenceUserSelect.empty().append('<option value="">Fehler beim Laden</option>');
                 });
         }

         // --- ANGEPASSTE FUNKTION zum Laden der Supervisoren f√ºr eine OU ---
         // Diese Funktion ruft jetzt die korrekte Backend-Route auf und nutzt die Hilfsfunktion
         function fetchAndSetSupervisorsForOu(ouDn) {
             const url = `/supervisors?dn=${encodeURIComponent(ouDn)}`; // KORREKTE URL mit DN
             console.log("Lade Vorgesetzten-Liste von:", url);
              $('#supervisor').empty().append('<option value="">Lade Vorgesetzte...</option>'); // Ladeanzeige

             fetch(url)
                 .then(response => {
                     if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                     return response.json();
                 })
                 .then(supervisorList => {
                     // Verwende die Hilfsfunktion zum Bef√ºllen
                     populateSupervisorDropdown(supervisorList);
                 })
                 .catch(error => {
                     console.error("Fehler beim Laden der Vorgesetzten f√ºr OU:", error);
                      $('#supervisor').empty().append('<option value="">Fehler beim Laden</option>'); // Hinweis im Dropdown
                 });
         }

         // --- NEUE FUNKTION zum initialen Laden aller Supervisoren ---
         function loadInitialSupervisors() {
              const url = '/supervisors'; // KORREKTE URL ohne DN f√ºr alle Supervisoren
              console.log("Lade initiale Vorgesetzten-Liste von:", url);
              $('#supervisor').empty().append('<option value="">Lade Vorgesetzte...</option>'); // Ladeanzeige

              fetch(url)
                  .then(response => {
                     if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                     return response.json();
                  })
                  .then(supervisorList => {
                      // Verwende die Hilfsfunktion zum Bef√ºllen
                      populateSupervisorDropdown(supervisorList);
                  })
                  .catch(error => {
                      console.error("Fehler beim initialen Laden aller Vorgesetzten:", error);
                       $('#supervisor').empty().append('<option value="">Fehler beim Laden</option>'); // Hinweis im Dropdown
                  });
         }


        $(document).ready(function () {
            const departmentInput = $('#department');
            const departmentDnInput = $('#department_dn');
            const ouTreeDiv = $('#ou-tree');

            // Lade initial ALLE Vorgesetzten
            loadInitialSupervisors();

            // Event Handler f√ºr OU Tree Auswahl
            ouTreeDiv.on("select_node.jstree", function (e, data) {
                 // data.node enth√§lt den ausgew√§hlten Knoten
                 const selectedNode = data.node;
                 // Verwende data.dn f√ºr den Distinguished Name (falls im Backend so gesetzt)
                 const dn = selectedNode.data?.dn; // Sicherer Zugriff
                 const name = selectedNode.text; // Der angezeigte Name

                 if (dn) {
                    console.log("OU ausgew√§hlt:", name, "DN:", dn);
                    departmentInput.val(name);
                    departmentDnInput.val(dn);
                    // Lade Referenzbenutzer und Vorgesetzte f√ºr die ausgew√§hlte OU
                    fetchUsersForReference(dn);
                    fetchAndSetSupervisorsForOu(dn); // Ruft die korrigierte Funktion auf
                 } else {
                     console.warn("Ausgew√§hlter Knoten hat keinen DN:", selectedNode);
                     // Setze Felder zur√ºck oder lade globale Liste, falls kein DN vorhanden
                     departmentInput.val('');
                     departmentDnInput.val('');
                     $('#referenceuser').empty().append(new Option("Bitte Abteilung w√§hlen", ""));
                     loadInitialSupervisors(); // Lade globale Liste wenn kein DN
                 }
            });

            // Event Listener f√ºr Dockingstation Checkbox (basierend auf Laptop-Auswahl)
             $('input[name="hardware_computer"]').on('change', function() {
                 const dockingDiv = $('#dockingstationDiv');
                 if (this.value === 'Laptop' && $('#needs_hardware').prop('checked')) {
                     dockingDiv.show(); // Zeige nur wenn Laptop UND Hardware ben√∂tigt
                 } else {
                     dockingDiv.hide();
                     $('#Dockingstation').prop('checked', false); // Optional: Checkbox zur√ºcksetzen
                 }
             });
             // Stelle sicher, dass Dockingstation initial korrekt angezeigt wird, falls Laptop vorausgew√§hlt ist
             if ($('input[name="hardware_computer"][value="Laptop"]').is(':checked') && $('#needs_hardware').prop('checked')) {
                  $('#dockingstationDiv').show();
             }


             // Initialzustand der Felder beim Laden der Seite setzen
             toggleWindowsUserFields();
             toggleHardwareFields();

             // Formular-Validierung beim Absenden (optional, HTML5 required ist oft ausreichend)
             $('#onoffboarding-form').on('submit', function(event) {
                  let isValid = true;
                  // Beispiel: Pr√ºfe ob Vorgesetzter ausgew√§hlt ist, wenn Windows ben√∂tigt wird
                  if ($('#needs_windows_user').prop('checked') && $('#supervisor').val() === '') {
                       alert('Bitte w√§hlen Sie einen Vorgesetzten aus.');
                       $('#supervisor').focus(); // Fokus auf das Feld setzen
                       isValid = false;
                  }

                  // Weitere clientseitige Pr√ºfungen hier...

                  if (!isValid) {
                       event.preventDefault(); // Verhindere das Absenden
                  }
                  // Wenn alles g√ºltig ist, wird das Formular normal abgeschickt
             });

        });
    </script>
</body>
</html>
